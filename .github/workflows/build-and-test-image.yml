name: Build and Test NHN Cloud Instance Image

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: 'Skip resource cleanup (for debugging)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  PROMTAIL_VERSION: '3.6.4'

jobs:
  build-and-test:
    name: Build and Test Instance Image
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install NHN Cloud CLI dependencies
        run: |
          pip install --upgrade pip
          pip install requests python-dotenv

      - name: Create temporary SSH key
        id: ssh_key
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/nhn_temp_key -N "" -C "github-actions-temp"
          echo "private_key_path=$HOME/.ssh/nhn_temp_key" >> $GITHUB_OUTPUT
          echo "public_key_path=$HOME/.ssh/nhn_temp_key.pub" >> $GITHUB_OUTPUT
          chmod 600 ~/.ssh/nhn_temp_key

      - name: Create build instance on NHN Cloud
        id: create_instance
        env:
          NHN_AUTH_URL: ${{ secrets.NHN_AUTH_URL }}
          NHN_TENANT_ID: ${{ secrets.NHN_TENANT_ID }}
          NHN_USERNAME: ${{ secrets.NHN_USERNAME }}
          NHN_PASSWORD: ${{ secrets.NHN_PASSWORD }}
          NHN_REGION: ${{ secrets.NHN_REGION }}
          NHN_FLAVOR_ID: ${{ secrets.NHN_FLAVOR_ID }}
          NHN_IMAGE_ID: ${{ secrets.NHN_IMAGE_ID }}
          NHN_NETWORK_ID: ${{ secrets.NHN_NETWORK_ID }}
          NHN_SECURITY_GROUP_ID: ${{ secrets.NHN_SECURITY_GROUP_ID }}
          SSH_PUBLIC_KEY: ${{ steps.ssh_key.outputs.public_key_path }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          import json
          import time
          import requests
          from datetime import datetime

          # NHN Cloud ì¸ì¦ ì •ë³´
          auth_url = os.environ['NHN_AUTH_URL']
          tenant_id = os.environ['NHN_TENANT_ID']
          username = os.environ['NHN_USERNAME']
          password = os.environ['NHN_PASSWORD']
          region = os.environ['NHN_REGION']

          # ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì •ë³´
          flavor_id = os.environ['NHN_FLAVOR_ID']
          image_id = os.environ['NHN_IMAGE_ID']
          network_id = os.environ['NHN_NETWORK_ID']
          security_group_id = os.environ.get('NHN_SECURITY_GROUP_ID', '')

          # SSH ê³µê°œ í‚¤ ì½ê¸°
          with open(os.environ['SSH_PUBLIC_KEY'], 'r') as f:
              ssh_public_key = f.read().strip()

          # 1. í† í° ë°œê¸‰
          print("ðŸ” NHN Cloud ì¸ì¦ ì¤‘...")
          auth_payload = {
              "auth": {
                  "tenantId": tenant_id,
                  "passwordCredentials": {
                      "username": username,
                      "password": password
                  }
              }
          }
          
          auth_response = requests.post(f"{auth_url}/tokens", json=auth_payload)
          auth_response.raise_for_status()
          token = auth_response.json()['access']['token']['id']
          
          # Compute API endpoint
          compute_url = None
          for service in auth_response.json()['access']['serviceCatalog']:
              if service['type'] == 'compute':
                  for endpoint in service['endpoints']:
                      if endpoint.get('region') == region:
                          compute_url = endpoint['publicURL']
                          break
          
          if not compute_url:
              print(f"âŒ Compute endpoint not found for region: {region}")
              sys.exit(1)

          headers = {
              "X-Auth-Token": token,
              "Content-Type": "application/json"
          }

          # 2. í‚¤íŽ˜ì–´ ë“±ë¡
          keypair_name = f"github-actions-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
          print(f"ðŸ”‘ í‚¤íŽ˜ì–´ ë“±ë¡ ì¤‘: {keypair_name}")
          
          keypair_payload = {
              "keypair": {
                  "name": keypair_name,
                  "public_key": ssh_public_key
              }
          }
          
          try:
              keypair_response = requests.post(
                  f"{compute_url}/os-keypairs",
                  headers=headers,
                  json=keypair_payload
              )
              keypair_response.raise_for_status()
          except requests.exceptions.HTTPError as e:
              print(f"âš ï¸  í‚¤íŽ˜ì–´ ë“±ë¡ ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ìž¬í•  ìˆ˜ ìžˆìŒ): {e}")

          # 3. ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
          instance_name = f"photo-api-build-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
          print(f"ðŸš€ ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘: {instance_name}")

          server_payload = {
              "server": {
                  "name": instance_name,
                  "flavorRef": flavor_id,
                  "imageRef": image_id,
                  "networks": [{"uuid": network_id}],
                  "key_name": keypair_name,
                  "metadata": {
                      "purpose": "github-actions-build",
                      "app": "photo-api"
                  }
              }
          }

          if security_group_id:
              server_payload["server"]["security_groups"] = [{"name": security_group_id}]

          server_response = requests.post(
              f"{compute_url}/servers",
              headers=headers,
              json=server_payload
          )
          server_response.raise_for_status()
          server_id = server_response.json()['server']['id']
          
          print(f"âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ìš”ì²­ ì™„ë£Œ: {server_id}")

          # 4. ì¸ìŠ¤í„´ìŠ¤ ACTIVE ìƒíƒœ ëŒ€ê¸°
          print("â³ ì¸ìŠ¤í„´ìŠ¤ê°€ ACTIVE ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...")
          max_wait = 600  # 10ë¶„
          start_time = time.time()
          
          while time.time() - start_time < max_wait:
              server_detail_response = requests.get(
                  f"{compute_url}/servers/{server_id}",
                  headers=headers
              )
              server_detail_response.raise_for_status()
              server_status = server_detail_response.json()['server']['status']
              
              if server_status == 'ACTIVE':
                  server_data = server_detail_response.json()['server']
                  # IP ì£¼ì†Œ ì¶”ì¶œ
                  ip_address = None
                  for network_name, addresses in server_data.get('addresses', {}).items():
                      for addr in addresses:
                          if addr.get('version') == 4:
                              ip_address = addr['addr']
                              break
                      if ip_address:
                          break
                  
                  if not ip_address:
                      print("âŒ IP ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                      sys.exit(1)
                  
                  print(f"âœ… ì¸ìŠ¤í„´ìŠ¤ ACTIVE: IP={ip_address}")
                  
                  # GitHub Actions output ì„¤ì •
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"instance_id={server_id}\n")
                      f.write(f"instance_ip={ip_address}\n")
                      f.write(f"instance_name={instance_name}\n")
                      f.write(f"keypair_name={keypair_name}\n")
                      f.write(f"token={token}\n")
                      f.write(f"compute_url={compute_url}\n")
                  
                  break
              elif server_status == 'ERROR':
                  print(f"âŒ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨: {server_status}")
                  sys.exit(1)
              
              print(f"  ìƒíƒœ: {server_status}, ëŒ€ê¸° ì¤‘...")
              time.sleep(10)
          else:
              print("âŒ íƒ€ìž„ì•„ì›ƒ: ì¸ìŠ¤í„´ìŠ¤ê°€ ACTIVE ìƒíƒœê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              sys.exit(1)

          PYTHON_SCRIPT

      - name: Wait for SSH to be ready
        run: |
          echo "â³ SSH ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                -i ${{ steps.ssh_key.outputs.private_key_path }} \
                ubuntu@${{ steps.create_instance.outputs.instance_ip }} \
                "echo 'SSH ì—°ê²° ì„±ê³µ'" 2>/dev/null; then
              echo "âœ… SSH ì—°ê²° ê°€ëŠ¥"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "  ì‹œë„ $attempt/$max_attempts..."
            sleep 10
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi

      - name: Prepare build environment
        run: |
          echo "ðŸ“¦ ë¹Œë“œ í™˜ê²½ ì„¤ì • ì¤‘..."
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ë©”íŠ¸ë¦­ì€ Prometheusê°€ /metrics ìŠ¤í¬ëž˜í•‘)
          cat > .env.build << EOF
          LOKI_URL=${{ secrets.LOKI_URL }}
          INSTANCE_IP=${{ steps.create_instance.outputs.instance_ip }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          NHN_OBJECT_STORAGE_ENDPOINT=${{ secrets.NHN_OBJECT_STORAGE_ENDPOINT }}
          NHN_OBJECT_STORAGE_ACCESS_KEY=${{ secrets.NHN_OBJECT_STORAGE_ACCESS_KEY }}
          NHN_OBJECT_STORAGE_SECRET_KEY=${{ secrets.NHN_OBJECT_STORAGE_SECRET_KEY }}
          NHN_CDN_DOMAIN=${{ secrets.NHN_CDN_DOMAIN }}
          NHN_CDN_AUTH_KEY=${{ secrets.NHN_CDN_AUTH_KEY }}
          EOF

      - name: Upload source code to build instance
        run: |
          echo "ðŸ“¤ ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ ì¤‘..."
          
          # rsyncë¡œ ì†ŒìŠ¤ ì½”ë“œ ì „ì†¡
          rsync -avz --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
            --exclude='venv' --exclude='.env' --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            ./ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/photo-api/
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì „ì†¡
          scp -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            .env.build ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/photo-api/.env
          
          echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Download dependencies offline
        run: |
          echo "ðŸ“¥ ì˜¤í”„ë¼ì¸ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          
          # Python íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          mkdir -p offline-packages
          pip download -r requirements.txt -d offline-packages/
          
          # Promtail ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ
          echo "ðŸ“¥ Promtail ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -sSL -o offline-packages/promtail.zip \
            "https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-amd64.zip"
          
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

      - name: Upload offline packages to build instance
        run: |
          echo "ðŸ“¤ ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì¤‘..."
          
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            offline-packages/ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/offline-packages/
          
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Build image on instance
        run: |
          echo "ðŸ”¨ ì¸ìŠ¤í„´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          
          ssh -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} << 'REMOTE_SCRIPT'
          set -euo pipefail
          
          echo "=== 1ë‹¨ê³„: Python ì„¤ì¹˜ ==="
          sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            curl ca-certificates build-essential libffi-dev libssl-dev \
            software-properties-common unzip
          
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3.11 python3.11-venv python3.11-dev
          
          echo "=== 2ë‹¨ê³„: Photo API ì„¤ì • ==="
          sudo mkdir -p /opt/photo-api /var/log/photo-api
          sudo rsync -a /tmp/photo-api/ /opt/photo-api/
          sudo chmod 755 /var/log/photo-api
          
          # ì „ìš© ì‚¬ìš©ìž ìƒì„±
          sudo useradd -r -s /usr/sbin/nologin -d /opt/photo-api photo-api 2>/dev/null || true
          
          # Python ê°€ìƒí™˜ê²½ ë° ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          python3.11 -m venv /opt/photo-api/venv
          /opt/photo-api/venv/bin/pip install --upgrade pip --no-index --find-links=/tmp/offline-packages
          /opt/photo-api/venv/bin/pip install --no-index --find-links=/tmp/offline-packages -r /opt/photo-api/requirements.txt
          
          # systemd ì„œë¹„ìŠ¤ ìƒì„±
          sudo tee /etc/systemd/system/photo-api.service > /dev/null << 'SVC'
          [Unit]
          Description=Photo API
          After=network.target

          [Service]
          Type=simple
          User=photo-api
          Group=photo-api
          WorkingDirectory=/opt/photo-api
          Environment="PATH=/opt/photo-api/venv/bin:/usr/local/bin:/usr/bin:/bin"
          EnvironmentFile=/opt/photo-api/.env
          ExecStart=/opt/photo-api/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
          Restart=on-failure
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=photo-api
          ReadWritePaths=/var/log/photo-api

          [Install]
          WantedBy=multi-user.target
          SVC
          
          sudo chown -R photo-api:photo-api /opt/photo-api /var/log/photo-api
          
          echo "=== 3ë‹¨ê³„: Promtail ì„¤ì • ==="
          sudo mkdir -p /opt/promtail /var/lib/promtail
          
          # ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ì—ì„œ ì„¤ì¹˜
          unzip -q /tmp/offline-packages/promtail.zip -d /tmp/
          sudo mv /tmp/promtail-linux-amd64 /opt/promtail/promtail 2>/dev/null || \
            sudo mv /tmp/promtail /opt/promtail/promtail
          sudo chmod +x /opt/promtail/promtail
          
          sudo cp /opt/photo-api/conf/promtail-config.yaml /opt/promtail/promtail-config.yaml
          
          # Promtail systemd ì„œë¹„ìŠ¤
          sudo tee /etc/systemd/system/promtail.service > /dev/null << 'EOF'
          [Unit]
          Description=Promtail
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          EnvironmentFile=/opt/photo-api/.env
          ExecStart=/opt/promtail/promtail -config.file=/opt/promtail/promtail-config.yaml -config.expand-env=true
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          EOF
          
          echo "=== systemd ì„œë¹„ìŠ¤ í™œì„±í™” ==="
          sudo systemctl daemon-reload
          sudo systemctl enable photo-api.service
          sudo systemctl enable promtail.service
          
          echo "=== ì •ë¦¬ ==="
          sudo rm -rf /tmp/photo-api /tmp/offline-packages
          
          echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          REMOTE_SCRIPT
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

      - name: Stop instance before creating image
        run: |
          echo "â¹ï¸  ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•´ ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€ ì¤‘..."
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          import time
          import requests

          token = "${{ steps.create_instance.outputs.token }}"
          compute_url = "${{ steps.create_instance.outputs.compute_url }}"
          server_id = "${{ steps.create_instance.outputs.instance_id }}"

          headers = {
              "X-Auth-Token": token,
              "Content-Type": "application/json"
          }

          # ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
          stop_payload = {"os-stop": None}
          response = requests.post(
              f"{compute_url}/servers/{server_id}/action",
              headers=headers,
              json=stop_payload
          )
          response.raise_for_status()
          
          print("â³ ì¸ìŠ¤í„´ìŠ¤ê°€ SHUTOFF ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...")
          max_wait = 300
          start_time = time.time()
          
          while time.time() - start_time < max_wait:
              detail_response = requests.get(
                  f"{compute_url}/servers/{server_id}",
                  headers=headers
              )
              detail_response.raise_for_status()
              status = detail_response.json()['server']['status']
              
              if status == 'SHUTOFF':
                  print("âœ… ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€ ì™„ë£Œ")
                  break
              
              print(f"  ìƒíƒœ: {status}, ëŒ€ê¸° ì¤‘...")
              time.sleep(5)
          else:
              print("âŒ íƒ€ìž„ì•„ì›ƒ: ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤‘ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              sys.exit(1)
          PYTHON_SCRIPT

      - name: Create instance image
        id: create_image
        run: |
          echo "ðŸ“¸ ì¸ìŠ¤í„´ìŠ¤ ì´ë¯¸ì§€ ìƒì„± ì¤‘..."
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          import time
          import requests
          from datetime import datetime

          token = "${{ steps.create_instance.outputs.token }}"
          compute_url = "${{ steps.create_instance.outputs.compute_url }}"
          server_id = "${{ steps.create_instance.outputs.instance_id }}"

          headers = {
              "X-Auth-Token": token,
              "Content-Type": "application/json"
          }

          # ì´ë¯¸ì§€ ì´ë¦„
          image_name = f"photo-api-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
          
          # ì´ë¯¸ì§€ ìƒì„±
          create_image_payload = {
              "createImage": {
                  "name": image_name,
                  "metadata": {
                      "purpose": "github-actions-build",
                      "app": "photo-api",
                      "git_sha": "${{ github.sha }}"
                  }
              }
          }
          
          response = requests.post(
              f"{compute_url}/servers/{server_id}/action",
              headers=headers,
              json=create_image_payload
          )
          response.raise_for_status()
          
          # Image API endpoint ì°¾ê¸° (Glance)
          image_url = compute_url.replace('/compute/', '/image/')
          
          print(f"â³ ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸° ì¤‘: {image_name}")
          max_wait = 900  # 15ë¶„
          start_time = time.time()
          
          # ì´ë¯¸ì§€ ID ì°¾ê¸°
          image_id = None
          while time.time() - start_time < max_wait:
              images_response = requests.get(
                  f"{image_url}/v2/images?name={image_name}",
                  headers=headers
              )
              images_response.raise_for_status()
              images = images_response.json().get('images', [])
              
              if images:
                  image = images[0]
                  image_id = image['id']
                  status = image['status']
                  
                  if status == 'active':
                      print(f"âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: {image_id}")
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                          f.write(f"image_id={image_id}\n")
                          f.write(f"image_name={image_name}\n")
                      break
                  
                  print(f"  ìƒíƒœ: {status}, ëŒ€ê¸° ì¤‘...")
              
              time.sleep(15)
          else:
              print("âŒ íƒ€ìž„ì•„ì›ƒ: ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              sys.exit(1)
          PYTHON_SCRIPT

      - name: Create test instance from image
        id: test_instance
        run: |
          echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘..."
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          import time
          import requests
          from datetime import datetime

          token = "${{ steps.create_instance.outputs.token }}"
          compute_url = "${{ steps.create_instance.outputs.compute_url }}"
          image_id = "${{ steps.create_image.outputs.image_id }}"
          
          network_id = "${{ secrets.NHN_NETWORK_ID }}"
          flavor_id = "${{ secrets.NHN_FLAVOR_ID }}"
          security_group_id = "${{ secrets.NHN_SECURITY_GROUP_ID }}"
          keypair_name = "${{ steps.create_instance.outputs.keypair_name }}"

          headers = {
              "X-Auth-Token": token,
              "Content-Type": "application/json"
          }

          # í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
          instance_name = f"photo-api-test-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
          
          server_payload = {
              "server": {
                  "name": instance_name,
                  "flavorRef": flavor_id,
                  "imageRef": image_id,
                  "networks": [{"uuid": network_id}],
                  "key_name": keypair_name,
                  "metadata": {
                      "purpose": "github-actions-test",
                      "app": "photo-api"
                  }
              }
          }

          if security_group_id:
              server_payload["server"]["security_groups"] = [{"name": security_group_id}]

          server_response = requests.post(
              f"{compute_url}/servers",
              headers=headers,
              json=server_payload
          )
          server_response.raise_for_status()
          test_server_id = server_response.json()['server']['id']
          
          print(f"â³ í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ACTIVE ëŒ€ê¸° ì¤‘: {test_server_id}")
          max_wait = 600
          start_time = time.time()
          
          while time.time() - start_time < max_wait:
              detail_response = requests.get(
                  f"{compute_url}/servers/{test_server_id}",
                  headers=headers
              )
              detail_response.raise_for_status()
              server_data = detail_response.json()['server']
              status = server_data['status']
              
              if status == 'ACTIVE':
                  # IP ì¶”ì¶œ
                  ip_address = None
                  for network_name, addresses in server_data.get('addresses', {}).items():
                      for addr in addresses:
                          if addr.get('version') == 4:
                              ip_address = addr['addr']
                              break
                      if ip_address:
                          break
                  
                  print(f"âœ… í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ACTIVE: {ip_address}")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"test_instance_id={test_server_id}\n")
                      f.write(f"test_instance_ip={ip_address}\n")
                  break
              elif status == 'ERROR':
                  print(f"âŒ í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨")
                  sys.exit(1)
              
              print(f"  ìƒíƒœ: {status}, ëŒ€ê¸° ì¤‘...")
              time.sleep(10)
          else:
              print("âŒ íƒ€ìž„ì•„ì›ƒ: í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹œìž‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              sys.exit(1)
          PYTHON_SCRIPT

      - name: Wait for test instance services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸° ì¤‘..."
          sleep 60  # systemd ì„œë¹„ìŠ¤ê°€ ë¶€íŒ… ì‹œ ìžë™ ì‹œìž‘ë˜ë„ë¡ ëŒ€ê¸°

      - name: Test image with curl
        run: |
          echo "ðŸ§ª ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ ì¤‘..."
          
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            echo "  ì‹œë„ $((attempt + 1))/$max_attempts: Health check..."
            
            if curl -f -s -o /dev/null -w "%{http_code}" \
                http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/health | grep -q 200; then
              echo "âœ… Health check ì„±ê³µ"
              
              # API ì •ë³´ í™•ì¸
              echo "ðŸ“Š API ì •ë³´:"
              curl -s http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/ | jq .
              
              # Metrics í™•ì¸
              echo "ðŸ“ˆ Prometheus ë©”íŠ¸ë¦­ í™•ì¸:"
              curl -s http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/metrics | head -20
              
              echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            sleep 10
          done
          
          echo "âŒ Health check ì‹¤íŒ¨"
          
          # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
          echo "ðŸ” ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
          ssh -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.test_instance.outputs.test_instance_ip }} << 'DEBUG'
          echo "=== systemd ì„œë¹„ìŠ¤ ìƒíƒœ ==="
          sudo systemctl status photo-api.service --no-pager || true
          echo "=== photo-api ë¡œê·¸ ==="
          sudo journalctl -u photo-api.service -n 50 --no-pager || true
          echo "=== í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
          ps aux | grep -E 'uvicorn|python' || true
          echo "=== í¬íŠ¸ í™•ì¸ ==="
          sudo netstat -tlnp | grep 8000 || true
          DEBUG
          
          exit 1

      - name: Cleanup resources
        if: always() && github.event.inputs.skip_cleanup != 'true'
        run: |
          echo "ðŸ§¹ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests

          token = "${{ steps.create_instance.outputs.token }}"
          compute_url = "${{ steps.create_instance.outputs.compute_url }}"
          
          build_instance_id = "${{ steps.create_instance.outputs.instance_id }}"
          test_instance_id = "${{ steps.test_instance.outputs.test_instance_id }}"
          keypair_name = "${{ steps.create_instance.outputs.keypair_name }}"

          headers = {
              "X-Auth-Token": token,
              "Content-Type": "application/json"
          }

          # ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ
          if build_instance_id:
              try:
                  print(f"ðŸ—‘ï¸  ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì¤‘: {build_instance_id}")
                  requests.delete(
                      f"{compute_url}/servers/{build_instance_id}",
                      headers=headers
                  )
                  print("âœ… ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ìš”ì²­ ì™„ë£Œ")
              except Exception as e:
                  print(f"âš ï¸  ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: {e}")

          # í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ
          if test_instance_id:
              try:
                  print(f"ðŸ—‘ï¸  í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì¤‘: {test_instance_id}")
                  requests.delete(
                      f"{compute_url}/servers/{test_instance_id}",
                      headers=headers
                  )
                  print("âœ… í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ìš”ì²­ ì™„ë£Œ")
              except Exception as e:
                  print(f"âš ï¸  í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: {e}")

          # í‚¤íŽ˜ì–´ ì‚­ì œ
          if keypair_name:
              try:
                  print(f"ðŸ”‘ í‚¤íŽ˜ì–´ ì‚­ì œ ì¤‘: {keypair_name}")
                  requests.delete(
                      f"{compute_url}/os-keypairs/{keypair_name}",
                      headers=headers
                  )
                  print("âœ… í‚¤íŽ˜ì–´ ì‚­ì œ ì™„ë£Œ")
              except Exception as e:
                  print(f"âš ï¸  í‚¤íŽ˜ì–´ ì‚­ì œ ì‹¤íŒ¨: {e}")

          print("âœ… ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ")
          PYTHON_SCRIPT

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ID | ${{ steps.create_instance.outputs.instance_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ IP | ${{ steps.create_instance.outputs.instance_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒì„±ëœ ì´ë¯¸ì§€ ID | ${{ steps.create_image.outputs.image_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ ì´ë¦„ | ${{ steps.create_image.outputs.image_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ID | ${{ steps.test_instance.outputs.test_instance_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ IP | ${{ steps.test_instance.outputs.test_instance_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìƒì„±ëœ ì´ë¯¸ì§€ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë¯¸ì§€ ì´ë¦„**: ${{ steps.create_image.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë¯¸ì§€ ID**: ${{ steps.create_image.outputs.image_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ì‹œê°„**: $(date -u)" >> $GITHUB_STEP_SUMMARY
